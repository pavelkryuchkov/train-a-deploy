import{a as ke,b as Fe}from"./chunk-LLSMG6JW.js";import{a as Ee}from"./chunk-NJYODPAX.js";import{a as ye}from"./chunk-C4I5BNIN.js";import{a as Ce,b as Se,c as be}from"./chunk-KSIR7E56.js";import{a as ve,b as Ie}from"./chunk-M7QRXDID.js";import{c as Me}from"./chunk-XHIO73UL.js";import"./chunk-75JWDN2T.js";import{a as xe}from"./chunk-3CBS5LUE.js";import{a as fe}from"./chunk-VWW3BTGU.js";import{b as he}from"./chunk-JVXBUNOY.js";import"./chunk-3UFS333W.js";import{a as we,b as Te,c as Pe,g as Oe}from"./chunk-CIYPUJU4.js";import"./chunk-WZ5YG6XP.js";import"./chunk-PFZXV2AN.js";import"./chunk-YYDFMGLE.js";import{a as ge,c as _e}from"./chunk-HNLLFOR2.js";import"./chunk-DSLT4UPT.js";import{a as H,b as ue}from"./chunk-6GQCZ2II.js";import{f as de,g as pe,j as le,l as me}from"./chunk-MGKMNOKB.js";import{$ as Z,Aa as O,Cb as U,Eb as A,Fb as B,Gb as re,Gc as S,Ha as ne,Hb as E,Ib as F,Ic as ce,Jb as s,K as X,Kb as d,Lb as Y,Nb as L,Sb as k,Ub as g,a as q,ca as ee,db as _,dc as h,eb as w,ec as ae,fc as M,ga as te,gc as oe,hc as se,la as ie,mc as N,nc as R,pc as J,qa as $,qb as v,qc as K,rc as Q,u as W,xb as y,za as P,zb as j}from"./chunk-PPSF5JR2.js";var z=()=>[],De=(t,r)=>({occupied:t,selected:r});function Be(t,r){if(t&1){let i=L();s(0,"div",8),k("click",function(){let n=P(i).ngIf,o=g(3);return O(o.onClick(n))}),h(1),d()}if(t&2){let i=r.ngIf,e=g(3);U(J(3,De,e.card.occupiedSeats.includes(i),e.selected&&e.selected.carId===e.card.id&&e.selected.seatNumber===i)),_(),M(" ",i," ")}}function Re(t,r){if(t&1&&y(0,Be,2,6,"div",7),t&2){let i=r.$index,e=g().$index,n=g();j("ngIf",i+1+e*(n.card.rightSeats+n.card.leftSeats)+n.card.leftSeats)}}function $e(t,r){if(t&1&&(s(0,"div",5),E(1,Re,1,1,"div",6,B),d()),t&2){let i=g();_(),F(R(0,z).constructor(i.card.rightSeats))}}function Ae(t,r){if(t&1){let i=L();s(0,"div",8),k("click",function(){let n=P(i).ngIf,o=g(3);return O(o.onClick(n))}),h(1),d()}if(t&2){let i=r.ngIf,e=g(3);U(J(3,De,e.card.occupiedSeats.includes(i),e.selected&&e.selected.carId===e.card.id&&e.selected.seatNumber===i)),_(),M(" ",i," ")}}function Ne(t,r){if(t&1&&y(0,Ae,2,6,"div",7),t&2){let i=r.$index,e=g().$index,n=g();j("ngIf",i+1+e*(n.card.rightSeats+n.card.leftSeats))}}function He(t,r){if(t&1&&(s(0,"div",5),E(1,Ne,1,1,"div",6,B),d()),t&2){let i=g();_(),F(R(0,z).constructor(i.card.leftSeats))}}var Le=(()=>{let r=class r{constructor(){this.seatSelected=new ne,this.seats=0}ngOnInit(){this.seats=(this.card.leftSeats+this.card.rightSeats)*this.card.rows-this.card.occupiedSeats.length}onClick(e){this.card.occupiedSeats.includes(e)||this.seatSelected.emit({carId:this.card.id,seatNumber:e})}};r.\u0275fac=function(n){return new(n||r)},r.\u0275cmp=$({type:r,selectors:[["app-carriage-card"]],inputs:{card:"card",selected:"selected"},outputs:{seatSelected:"seatSelected"},standalone:!0,features:[N],decls:16,vars:4,consts:[["appearance","outlined",1,"card-wrapper"],[1,"title"],[1,"title__seats"],[1,"carriage-schema"],[1,"seats"],[1,"row"],[1,"seat",3,"class"],["class","seat",3,"class","click",4,"ngIf"],[1,"seat",3,"click"]],template:function(n,o){n&1&&(s(0,"mat-card",0)(1,"mat-card-title",1)(2,"span"),h(3),d(),s(4,"div",2),h(5),d()(),s(6,"mat-card-content")(7,"div",3)(8,"div",4),h(9," R "),E(10,$e,3,1,"div",5,B),d(),s(12,"div",4),h(13," L "),E(14,He,3,1,"div",5,B),d()()()()),n&2&&(_(3),M("Car ",o.card.id+1,""),_(2),M("",o.seats," seats"),_(5),F(R(2,z).constructor(o.card.rows)),_(4),F(R(3,z).constructor(o.card.rows)))},dependencies:[Ce,Se,be,le],styles:[".card-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;overflow-x:auto}.title[_ngcontent-%COMP%]{display:flex;justify-content:start;align-items:center;gap:10px;margin:16px;font-size:18px;font-weight:700}.title__seats[_ngcontent-%COMP%]{font-weight:400;padding:0 10px;border:solid 1px rgb(158,158,158);border-radius:50px}.carriage-schema[_ngcontent-%COMP%]{display:inline-flex;flex-direction:column;gap:20px;border:1px solid rgb(201,201,201);border-radius:16px;padding:16px 64px 16px 48px}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]{display:flex;gap:5px;align-items:center}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:flex;flex-direction:column-reverse;gap:5px}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .seat[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:30px;height:30px;background-color:#003c7c;color:#fff;border-radius:5px;cursor:pointer;-webkit-user-select:none;user-select:none}@media (max-width: 650px){.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .seat[_ngcontent-%COMP%]{width:20px;height:20px;font-size:.6rem}}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .occupied[_ngcontent-%COMP%]{background-color:#b4b4b4;cursor:default}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .selected[_ngcontent-%COMP%]{background-color:#e6b412}@media (max-width: 650px){.carriage-schema[_ngcontent-%COMP%]{padding:10px 40px 10px 24px}}"],changeDetection:0});let t=r;return t})();var je=(()=>{let r=class r{constructor(e){this.http=e}setOrders(e,n,o,C){this.http.post("/api/order",{rideId:e,seat:n,stationStart:o,stationEnd:C}).subscribe()}getOrders(){return this.http.get("/api/order")}createOrder(e,n,o,C){return this.http.post("/api/order",{seat:e,rideId:n,stationStart:o,stationEnd:C}).pipe(X(V=>W(V)))}deleteOrder(e){return this.http.delete(`/api/order/${e}`)}getUsers(){return this.http.get("/api/users")}};r.\u0275fac=function(n){return new(n||r)(ie(ue))},r.\u0275prov=te({token:r,factory:r.\u0275fac,providedIn:"root"});let t=r;return t})();var Ge=(t,r)=>r.id;function qe(t,r){t&1&&Y(0,"mat-spinner",0)}function Ue(t,r){if(t&1&&(s(0,"div",17)(1,"span",18)(2,"span",19),h(3),d(),h(4),d(),s(5,"span",20),h(6),d()()),t&2){let i=g().$implicit,e=g(2);_(3),M("Carriage type ",e.carriagesMap()[i].name,""),_(),M(":\xA0",e.availableSeats()[i]," "),_(2),M("$",e.prices()[i],"")}}function Ye(t,r){if(t&1){let i=L();s(0,"app-carriage-card",21),k("seatSelected",function(n){P(i);let o=g(3);return O(o.onSeatSelect(n))}),d()}if(t&2){let i=r.$implicit,e=g(3);j("card",i)("selected",e.selectedSeat())}}function Je(t,r){if(t&1&&(s(0,"mat-tab",11),y(1,Ue,7,3,"ng-template",14),s(2,"div",15),E(3,Ye,1,2,"app-carriage-card",16,Ge),d()()),t&2){let i=g(2);_(3),F(i.filteredCards())}}function Ke(t,r){if(t&1&&(s(0,"span",13),h(1),d()),t&2){let i=g(2);_(),ae(i.bookingMessage())}}function Qe(t,r){t&1&&(s(0,"button",23),Y(1,"mat-spinner",25),d()),t&2&&j("disabled",!0)}function We(t,r){if(t&1){let i=L();s(0,"button",26),k("click",function(){P(i);let n=g(3);return O(n.onBookSeat())}),h(1,"Book seat"),d()}}function Xe(t,r){if(t&1&&(s(0,"div",22)(1,"span"),h(2),d(),s(3,"span"),h(4),d()(),y(5,Qe,2,1,"button",23)(6,We,2,0,"button",24)),t&2){let i,e=g(2);_(2),oe("Car\xA0",(((i=e.selectedSeat())==null?null:i.carId)||0)+1,",\xA0Seat\xA0",(i=e.selectedSeat())==null?null:i.seatNumber,""),_(2),M("$",e.prices()[e.carriageTypes()[e.selectedTab()]],""),_(),A(e.isBooking()?5:6)}}function Ze(t,r){if(t&1){let i=L();s(0,"header",1)(1,"button",2),k("click",function(){P(i);let n=g();return O(n.onGoBack())}),s(2,"mat-icon",3),h(3,"arrow_back"),d()(),s(4,"div",4)(5,"div",5),h(6),K(7,"date"),K(8,"date"),d(),s(9,"div",6)(10,"span"),h(11),d(),s(12,"button",7),k("click",function(){P(i);let n=g();return O(n.onOpenDialog())}),h(13," Route "),s(14,"mat-icon",8),h(15,"keyboard_arrow_down"),d()()()()(),s(16,"main",9)(17,"mat-tab-group",10),k("selectedIndexChange",function(n){P(i);let o=g();return O(o.onTabChange(n))}),E(18,Je,5,0,"mat-tab",11,re),d(),s(20,"div",12),y(21,Ke,2,1,"span",13)(22,Xe,7,4),d()()}if(t&2){let i=g();_(6),se(" ",i.stations().from,"\xA0\u2192\xA0",i.stations().to,"\xA0(",Q(7,6,i.tripTime().departure,"MMM d, HH:mm"),"\xA0\u2192\xA0",Q(8,9,i.tripTime().arrival,"MMM d, HH:mm"),") "),_(5),M("Ride ",i.rideId(),""),_(7),F(i.carriageTypes()),_(3),A(i.selectedSeat()?22:21)}}var Et=(()=>{let r=class r{constructor(e,n,o,C,V,b,D,I,f){this.stationsService=e,this.carriagesService=n,this.searchService=o,this.ordersService=C,this.authService=V,this.router=b,this.activatedRoute=D,this.location=I,this.dialog=f,this.rideId=v(null),this.fromId=v(null),this.toId=v(null),this.isLoadingStations=v(!1),this.isLoadingCarriages=v(!1),this.isLoadingRide=v(!1),this.isLoading=S(()=>this.isLoadingRide()||this.isLoadingStations()||this.isLoadingCarriages()),this.selectedTab=v(0),this.selectedSeat=v(null),this.isBooking=v(!1),this.bookingMessage=v("Please select an available seat"),this.ride=v(null),this.carriages=this.carriagesService.carriages,this.carriagesMap=this.carriagesService.carriagesMap,this.stations=S(()=>{let a=this.fromId(),c=this.toId(),p=this.stationsService.stationsMap(),l={from:"",to:""};return!a||!c||(l.from=p[a]?.city,l.to=p[c]?.city),l}),this.segmentIds=S(()=>{let a=this.fromId(),c=this.toId(),p=this.ride(),l={start:0,end:0};return!p||!a||!c||(l.start=p.path.findIndex(m=>m===a),l.end=p.path.findIndex(m=>m===c)),l}),this.tripTime=S(()=>{let a=this.segmentIds(),c=this.ride();return c?{departure:c.schedule.segments[a.start].time[0],arrival:c.schedule.segments[a.end-1].time[1]}:{departure:"",arrival:""}}),this.carriageTypes=S(()=>{let a=this.ride();return a?Array.from(new Set(a.carriages)):[]}),this.prices=S(()=>{let a=this.ride(),c=this.segmentIds();return a?a.schedule.segments.reduce((p,l,m)=>{if(m<c.start||m>=c.end)return p;let u=q({},p);return Object.entries(l.price).forEach(([x,T])=>{u[x]||(u[x]=0),u[x]+=T}),u},{}):{}}),this.seatOffsets=S(()=>{let a=this.ride(),c=this.carriagesMap();return a?a.carriages.reduce((p,l,m,u)=>{if(p.length===0)return[0];let x=c[u[m-1]],T=(x.leftSeats+x.rightSeats)*x.rows;return[...p,p[m-1]+T]},[]):[]}),this.occupiedSeatsSet=S(()=>{let a=this.ride(),c=this.segmentIds();return a?a.schedule.segments.reduce((p,l,m)=>(m<c.start||m>=c.end||l.occupiedSeats.forEach(u=>p.add(u)),p),new Set):new Set}),this.occupiedSeats=S(()=>{let a=this.ride(),c=this.seatOffsets(),p=this.occupiedSeatsSet();return a?a.carriages.map((l,m)=>{let[u,x]=[c[m]+1,c[m+1]||Number.POSITIVE_INFINITY],T=[];return p.forEach(G=>{G>=u&&G<=x&&T.push(G-u+1)}),T}):[]}),this.availableSeats=S(()=>{let a=this.occupiedSeats(),c=this.ride(),p=this.carriagesMap();return c?c.carriages.map((l,m)=>{let u=p[l],x=(u.leftSeats+u.rightSeats)*u.rows-a[m].length;return{code:l,seats:x}},[]).reduce((l,m)=>{let u=q({},l);return u[m.code]||(u[m.code]=0),u[m.code]+=m.seats,u},{}):{}}),this.carriageCards=S(()=>{let a=this.fromId(),c=this.toId(),p=this.ride(),l=this.carriagesMap(),m=this.occupiedSeats(),u=[];return!p||!a||!c||p.carriages.forEach((x,T)=>{u.push({id:T,code:x,rows:l[x]?.rows,leftSeats:l[x]?.leftSeats,rightSeats:l[x]?.rightSeats,occupiedSeats:m[T]||[]})}),u}),this.filteredCards=S(()=>{let a=this.carriageTypes()[this.selectedTab()];return this.carriageCards().filter(c=>c.code===a)}),ce(()=>{let a=this.segmentIds();(a.start===-1||a.end===-1)&&this.router.navigate(["/"])})}ngOnInit(){let e=this.activatedRoute.snapshot.paramMap.get("rideId"),n=this.activatedRoute.snapshot.queryParamMap.get("from"),o=this.activatedRoute.snapshot.queryParamMap.get("to");if(this.rideId.set(e?Number(e):null),this.fromId.set(n?Number(n):null),this.toId.set(o?Number(o):null),!this.rideId()||!this.fromId()||!this.toId()){this.router.navigate(["/"]);return}this.isLoadingRide.set(!0),this.searchService.getRide(this.rideId()).subscribe(C=>{if(this.isLoadingRide.set(!1),C instanceof H){this.router.navigate(["/"]);return}this.ride.set(C)}),this.isLoadingStations.set(!0),this.stationsService.getStations().subscribe(()=>{this.isLoadingStations.set(!1)}),this.isLoadingCarriages.set(!0),this.carriagesService.getCarriages().subscribe(()=>{this.isLoadingCarriages.set(!1)})}onGoBack(){this.location.back()}onOpenDialog(){let e=this.ride(),n=this.segmentIds(),o=this.stations(),C=this.stationsService.stationsMap();if(!e)return;let V=e.path.slice(n.start,n.end+1).map(f=>C[f].city),b=e.schedule.segments.slice(n.start,n.end).flatMap(f=>f.time).map(f=>pe(f,"MMM d, HH:mm","en")),D=[[b[0]]],I=["first station"];for(let f=1;f<b.length;f+=2)f!==b.length-1?(D.push([b[f],b[f+1]]),I.push(`${(new Date(b[f+1]).getTime()-new Date(b[f]).getTime())/1e3/60}m`)):(D.push([b[f]]),I.push("last station"));this.dialog.open(ke,{data:{routeId:e.routeId,path:V,time:D,stopTime:I,from:o.from,to:o.to},enterAnimationDuration:0,exitAnimationDuration:0})}onTabChange(e){this.selectedTab.set(e)}onSeatSelect(e){this.selectedSeat.set(e)}onBookSeat(){let e=this.rideId(),n=this.fromId(),o=this.toId(),C=this.selectedSeat();if(!C||!e||!n||!o)return;if(!this.authService.isLoggedIn()){this.router.navigate(["/signin"]);return}let{carId:V,seatNumber:b}=C,D=this.seatOffsets()[V]+b;this.isBooking.set(!0),this.ordersService.createOrder(D,e,n,o).pipe(ee(I=>{I instanceof H?this.bookingMessage.set(I.error.message):this.bookingMessage.set("Seat has been successfully booked")}),Z(()=>this.searchService.getRide(this.rideId()))).subscribe(I=>{this.selectedSeat.set(null),this.isBooking.set(!1),!(I instanceof H)&&this.ride.set(I)})}};r.\u0275fac=function(n){return new(n||r)(w(ye),w(Ee),w(Fe),w(je),w(he),w(_e),w(ge),w(de),w(Me))},r.\u0275cmp=$({type:r,selectors:[["app-trip-page"]],standalone:!0,features:[N],decls:2,vars:1,consts:[[1,"spinner"],[1,"header"],["mat-button","",3,"click"],[1,"icon"],[1,"header__content"],[1,"header__route"],[1,"header__ride"],["mat-button","",1,"button","modal",3,"click"],[1,"icon","modal"],[1,"main"],["animationDuration","0ms",1,"tab-group",3,"selectedIndexChange"],[1,"tab"],[1,"book"],[1,"book__error"],["mat-tab-label",""],[1,"cards-list"],[3,"card","selected"],[1,"tab__label"],[1,"tab__heading"],[1,"tab__carriage"],[1,"tab__price"],[3,"seatSelected","card","selected"],[1,"book__title"],["mat-button","",3,"disabled"],["mat-flat-button",""],["diameter","35",1,"spinner"],["mat-flat-button","",3,"click"]],template:function(n,o){n&1&&y(0,qe,1,0,"mat-spinner",0)(1,Ze,23,12),n&2&&A(o.isLoading()?0:1)},dependencies:[Le,xe,fe,Ie,ve,Oe,we,Te,Pe,me],styles:["[_nghost-%COMP%]{display:block;max-width:1300px;margin:0 auto;padding:20px}.spinner[_ngcontent-%COMP%]{margin:50px auto}.icon[_ngcontent-%COMP%]{width:24px!important;height:24px!important;margin:0!important;font-size:24px!important}.header[_ngcontent-%COMP%]{display:flex;align-items:center;border-bottom:1px solid #ccc;font-weight:800}.main[_ngcontent-%COMP%]{display:flex;align-items:end;justify-content:space-around;gap:30px;margin:20px 0}@media (max-width: 920px){.main[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}}.tab-group[_ngcontent-%COMP%]{min-width:0}.tab__label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:5px}.tab__heading[_ngcontent-%COMP%]{display:flex;align-items:center;font-weight:800}.tab__carriage[_ngcontent-%COMP%]{display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis}.cards-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px;margin-top:20px}.book[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:20px;gap:15px;border:1px solid #ccc;border-radius:12px;font-size:14px;position:sticky;bottom:24px;min-width:170px}.book__title[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding-bottom:7px;border-bottom:1px solid #ccc}.book__error[_ngcontent-%COMP%]{max-width:170px;text-align:center}@media (max-width: 920px){.book__error[_ngcontent-%COMP%]{max-width:100%}}@media (max-width: 920px){.book[_ngcontent-%COMP%]{padding:20px 50px;position:static}}@media (max-width: 600px){.book[_ngcontent-%COMP%]{padding:20px 30px}}.hidden[_ngcontent-%COMP%]{visibility:hidden}"],changeDetection:0});let t=r;return t})();export{Et as TripPageComponent};
