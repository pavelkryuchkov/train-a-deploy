import{a as Pe,b as ke}from"./chunk-AS4UUHOQ.js";import{a as _e}from"./chunk-EXM2XI3D.js";import{a as Se}from"./chunk-SG2J27ZK.js";import{a as ve}from"./chunk-PLFLKSHQ.js";import{a as be}from"./chunk-YP3E4DFS.js";import{a as ge,b as ue,c as he}from"./chunk-HAJTOM24.js";import{a as fe,b as xe}from"./chunk-WCVEZFQA.js";import{c as Ce}from"./chunk-57V65NWP.js";import"./chunk-Z6QEANO5.js";import{a as me}from"./chunk-4PPTANTY.js";import{b as pe}from"./chunk-NLOEENRT.js";import"./chunk-3UFS333W.js";import{a as Me,b as Ie,c as we,g as Te}from"./chunk-4QO5O7L3.js";import"./chunk-5POHLGBV.js";import{a as de,c as le}from"./chunk-YNWXQWJD.js";import"./chunk-QDL5SYJ2.js";import"./chunk-3X4PWRWX.js";import"./chunk-IP76CWZZ.js";import{a as H}from"./chunk-Y5E3HJHA.js";import{$ as W,$b as h,Ab as Y,Cb as N,Cc as C,Db as R,Eb as ee,Ec as ae,Fa as Z,Fb as E,Gb as F,Hb as o,Ib as c,Jb as J,Kc as re,Lb as D,Lc as oe,Ob as O,Oc as se,Qb as g,Qc as ce,a as q,ac as te,bb as u,bc as M,ca as X,cb as I,cc as ie,dc as ne,ic as $,jc as j,lc as K,mc as Q,nc as U,ob as b,pa as A,vb as y,xa as P,xb as L,ya as k}from"./chunk-G6VS4OII.js";var z=()=>[],Oe=(t,a)=>({occupied:t,selected:a});function Fe(t,a){if(t&1){let i=D();o(0,"div",8),O("click",function(){let n=P(i).ngIf,d=g(3);return k(d.onClick(n))}),h(1),c()}if(t&2){let i=a.ngIf,e=g(3);Y(K(3,Oe,e.card.occupiedSeats.includes(i),e.selected&&e.selected.carId===e.card.id&&e.selected.seatNumber===i)),u(),M(" ",i," ")}}function Ve(t,a){if(t&1&&y(0,Fe,2,6,"div",7),t&2){let i=a.$index,e=g().$index,n=g();L("ngIf",i+1+e*(n.card.rightSeats+n.card.leftSeats)+n.card.leftSeats)}}function De(t,a){if(t&1&&(o(0,"div",5),E(1,Ve,1,1,"div",6,R),c()),t&2){let i=g();u(),F(j(0,z).constructor(i.card.rightSeats))}}function Le(t,a){if(t&1){let i=D();o(0,"div",8),O("click",function(){let n=P(i).ngIf,d=g(3);return k(d.onClick(n))}),h(1),c()}if(t&2){let i=a.ngIf,e=g(3);Y(K(3,Oe,e.card.occupiedSeats.includes(i),e.selected&&e.selected.carId===e.card.id&&e.selected.seatNumber===i)),u(),M(" ",i," ")}}function Be(t,a){if(t&1&&y(0,Le,2,6,"div",7),t&2){let i=a.$index,e=g().$index,n=g();L("ngIf",i+1+e*(n.card.rightSeats+n.card.leftSeats))}}function Re(t,a){if(t&1&&(o(0,"div",5),E(1,Be,1,1,"div",6,R),c()),t&2){let i=g();u(),F(j(0,z).constructor(i.card.leftSeats))}}var ye=(()=>{let a=class a{constructor(){this.seatSelected=new Z,this.seats=0}ngOnInit(){this.seats=(this.card.leftSeats+this.card.rightSeats)*this.card.rows-this.card.occupiedSeats.length}onClick(e){this.card.occupiedSeats.includes(e)||this.seatSelected.emit({carId:this.card.id,seatNumber:e})}};a.\u0275fac=function(n){return new(n||a)},a.\u0275cmp=A({type:a,selectors:[["app-carriage-card"]],inputs:{card:"card",selected:"selected"},outputs:{seatSelected:"seatSelected"},standalone:!0,features:[$],decls:16,vars:4,consts:[["appearance","outlined",1,"card-wrapper"],[1,"title"],[1,"title__seats"],[1,"carriage-schema"],[1,"seats"],[1,"row"],[1,"seat",3,"class"],["class","seat",3,"class","click",4,"ngIf"],[1,"seat",3,"click"]],template:function(n,d){n&1&&(o(0,"mat-card",0)(1,"mat-card-title",1)(2,"span"),h(3),c(),o(4,"div",2),h(5),c()(),o(6,"mat-card-content")(7,"div",3)(8,"div",4),h(9," R "),E(10,De,3,1,"div",5,R),c(),o(12,"div",4),h(13," L "),E(14,Re,3,1,"div",5,R),c()()()()),n&2&&(u(3),M("Car ",d.card.id+1,""),u(2),M("",d.seats," seats"),u(5),F(j(2,z).constructor(d.card.rows)),u(4),F(j(3,z).constructor(d.card.rows)))},dependencies:[ge,ue,he,se],styles:[".card-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;overflow-x:auto}.title[_ngcontent-%COMP%]{display:flex;justify-content:start;align-items:center;gap:10px;margin:16px;font-size:18px;font-weight:700}.title__seats[_ngcontent-%COMP%]{font-weight:400;padding:0 10px;border:solid 1px rgb(158,158,158);border-radius:50px}.carriage-schema[_ngcontent-%COMP%]{display:inline-flex;flex-direction:column;gap:20px;border:1px solid rgb(201,201,201);border-radius:16px;padding:16px 64px 16px 48px}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]{display:flex;gap:5px;align-items:center}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:flex;flex-direction:column-reverse;gap:5px}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .seat[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:30px;height:30px;background-color:#003c7c;color:#fff;border-radius:5px;cursor:pointer;-webkit-user-select:none;user-select:none}@media (max-width: 650px){.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .seat[_ngcontent-%COMP%]{width:20px;height:20px;font-size:.6rem}}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .occupied[_ngcontent-%COMP%]{background-color:#b4b4b4;cursor:default}.carriage-schema[_ngcontent-%COMP%]   .seats[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]   .selected[_ngcontent-%COMP%]{background-color:#e6b412}@media (max-width: 650px){.carriage-schema[_ngcontent-%COMP%]{padding:10px 40px 10px 24px}}"],changeDetection:0});let t=a;return t})();var je=(t,a)=>a.id;function Ae(t,a){t&1&&J(0,"mat-spinner",0)}function Ne(t,a){if(t&1&&(o(0,"div",17)(1,"span",18)(2,"span",19),h(3),c(),h(4),c(),o(5,"span",20),h(6),c()()),t&2){let i=g().$implicit,e=g(2);u(3),M("Carriage type ",e.carriagesMap()[i].name,""),u(),M(":\xA0",e.availableSeats()[i]," "),u(2),M("$",e.prices()[i],"")}}function $e(t,a){if(t&1){let i=D();o(0,"app-carriage-card",21),O("seatSelected",function(n){P(i);let d=g(3);return k(d.onSeatSelect(n))}),c()}if(t&2){let i=a.$implicit,e=g(3);L("card",i)("selected",e.selectedSeat())}}function He(t,a){if(t&1&&(o(0,"mat-tab",11),y(1,Ne,7,3,"ng-template",14),o(2,"div",15),E(3,$e,1,2,"app-carriage-card",16,je),c()()),t&2){let i=g(2);u(3),F(i.filteredCards())}}function ze(t,a){if(t&1&&(o(0,"span",13),h(1),c()),t&2){let i=g(2);u(),te(i.bookingMessage())}}function Ge(t,a){t&1&&(o(0,"button",23),J(1,"mat-spinner",25),c()),t&2&&L("disabled",!0)}function qe(t,a){if(t&1){let i=D();o(0,"button",26),O("click",function(){P(i);let n=g(3);return k(n.onBookSeat())}),h(1,"Book seat"),c()}}function Ye(t,a){if(t&1&&(o(0,"div",22)(1,"span"),h(2),c(),o(3,"span"),h(4),c()(),y(5,Ge,2,1,"button",23)(6,qe,2,0,"button",24)),t&2){let i,e=g(2);u(2),ie("Car\xA0",(((i=e.selectedSeat())==null?null:i.carId)||0)+1,",\xA0Seat\xA0",(i=e.selectedSeat())==null?null:i.seatNumber,""),u(2),M("$",e.prices()[e.carriageTypes()[e.selectedTab()]],""),u(),N(e.isBooking()?5:6)}}function Je(t,a){if(t&1){let i=D();o(0,"header",1)(1,"button",2),O("click",function(){P(i);let n=g();return k(n.onGoBack())}),o(2,"mat-icon",3),h(3,"arrow_back"),c()(),o(4,"div",4)(5,"div",5),h(6),Q(7,"date"),Q(8,"date"),c(),o(9,"div",6)(10,"span"),h(11),c(),o(12,"button",7),O("click",function(){P(i);let n=g();return k(n.onOpenDialog())}),h(13," Route "),o(14,"mat-icon",8),h(15,"keyboard_arrow_down"),c()()()()(),o(16,"main",9)(17,"mat-tab-group",10),O("selectedIndexChange",function(n){P(i);let d=g();return k(d.onTabChange(n))}),E(18,He,5,0,"mat-tab",11,ee),c(),o(20,"div",12),y(21,ze,2,1,"span",13)(22,Ye,7,4),c()()}if(t&2){let i=g();u(6),ne(" ",i.stations().from,"\xA0\u2192\xA0",i.stations().to,"\xA0(",U(7,6,i.tripTime().departure,"MMM d, HH:mm"),"\xA0\u2192\xA0",U(8,9,i.tripTime().arrival,"MMM d, HH:mm"),") "),u(5),M("Ride ",i.rideId(),""),u(7),F(i.carriageTypes()),u(3),N(i.selectedSeat()?22:21)}}var It=(()=>{let a=class a{constructor(e,n,d,w,B,S,V,v,f){this.stationsService=e,this.carriagesService=n,this.searchService=d,this.ordersService=w,this.authService=B,this.router=S,this.activatedRoute=V,this.location=v,this.dialog=f,this.rideId=b(null),this.fromId=b(null),this.toId=b(null),this.isLoadingStations=b(!1),this.isLoadingCarriages=b(!1),this.isLoadingRide=b(!1),this.isLoading=C(()=>this.isLoadingRide()||this.isLoadingStations()||this.isLoadingCarriages()),this.selectedTab=b(0),this.selectedSeat=b(null),this.isBooking=b(!1),this.bookingMessage=b("Please select an available seat"),this.ride=b(null),this.carriages=this.carriagesService.carriages,this.carriagesMap=this.carriagesService.carriagesMap,this.stations=C(()=>{let r=this.fromId(),s=this.toId(),l=this.stationsService.stationsMap(),p={from:"",to:""};return!r||!s||(p.from=l[r]?.city,p.to=l[s]?.city),p}),this.segmentIds=C(()=>{let r=this.fromId(),s=this.toId(),l=this.ride(),p={start:0,end:0};return!l||!r||!s||(p.start=l.path.findIndex(m=>m===r),p.end=l.path.findIndex(m=>m===s)),p}),this.tripTime=C(()=>{let r=this.segmentIds(),s=this.ride();return s?{departure:s.schedule.segments[r.start].time[0],arrival:s.schedule.segments[r.end-1].time[1]}:{departure:"",arrival:""}}),this.carriageTypes=C(()=>{let r=this.ride();return r?Array.from(new Set(r.carriages)):[]}),this.prices=C(()=>{let r=this.ride(),s=this.segmentIds();return r?r.schedule.segments.reduce((l,p,m)=>{if(m<s.start||m>=s.end)return l;let _=q({},l);return Object.entries(p.price).forEach(([x,T])=>{_[x]||(_[x]=0),_[x]+=T}),_},{}):{}}),this.seatOffsets=C(()=>{let r=this.ride(),s=this.carriagesMap();return r?r.carriages.reduce((l,p,m,_)=>{if(l.length===0)return[0];let x=s[_[m-1]],T=(x.leftSeats+x.rightSeats)*x.rows;return[...l,l[m-1]+T]},[]):[]}),this.occupiedSeatsSet=C(()=>{let r=this.ride(),s=this.segmentIds();return r?r.schedule.segments.reduce((l,p,m)=>(m<s.start||m>=s.end||p.occupiedSeats.forEach(_=>l.add(_)),l),new Set):new Set}),this.occupiedSeats=C(()=>{let r=this.ride(),s=this.seatOffsets(),l=this.occupiedSeatsSet();return r?r.carriages.map((p,m)=>{let[_,x]=[s[m]+1,s[m+1]||Number.POSITIVE_INFINITY],T=[];return l.forEach(G=>{G>=_&&G<=x&&T.push(G-_+1)}),T}):[]}),this.availableSeats=C(()=>{let r=this.occupiedSeats(),s=this.ride(),l=this.carriagesMap();return s?s.carriages.map((p,m)=>{let _=l[p],x=(_.leftSeats+_.rightSeats)*_.rows-r[m].length;return{code:p,seats:x}},[]).reduce((p,m)=>{let _=q({},p);return _[m.code]||(_[m.code]=0),_[m.code]+=m.seats,_},{}):{}}),this.carriageCards=C(()=>{let r=this.fromId(),s=this.toId(),l=this.ride(),p=this.carriagesMap(),m=this.occupiedSeats(),_=[];return!l||!r||!s||l.carriages.forEach((x,T)=>{_.push({id:T,code:x,rows:p[x]?.rows,leftSeats:p[x]?.leftSeats,rightSeats:p[x]?.rightSeats,occupiedSeats:m[T]||[]})}),_}),this.filteredCards=C(()=>{let r=this.carriageTypes()[this.selectedTab()];return this.carriageCards().filter(s=>s.code===r)}),ae(()=>{let r=this.segmentIds();(r.start===-1||r.end===-1)&&this.router.navigate(["/"])})}ngOnInit(){let e=this.activatedRoute.snapshot.paramMap.get("rideId"),n=this.activatedRoute.snapshot.queryParamMap.get("from"),d=this.activatedRoute.snapshot.queryParamMap.get("to");if(this.rideId.set(e?Number(e):null),this.fromId.set(n?Number(n):null),this.toId.set(d?Number(d):null),!this.rideId()||!this.fromId()||!this.toId()){this.router.navigate(["/"]);return}this.isLoadingRide.set(!0),this.searchService.getRide(this.rideId()).subscribe(w=>{if(this.isLoadingRide.set(!1),w instanceof H){this.router.navigate(["/"]);return}this.ride.set(w)}),this.isLoadingStations.set(!0),this.stationsService.getStations().subscribe(()=>{this.isLoadingStations.set(!1)}),this.isLoadingCarriages.set(!0),this.carriagesService.getCarriages().subscribe(()=>{this.isLoadingCarriages.set(!1)})}onGoBack(){this.location.back()}onOpenDialog(){let e=this.ride(),n=this.segmentIds(),d=this.stations(),w=this.stationsService.stationsMap();if(!e)return;let B=e.path.slice(n.start,n.end+1).map(f=>w[f].city),S=e.schedule.segments.slice(n.start,n.end).flatMap(f=>f.time).map(f=>oe(f,"MMM d, HH:mm","en")),V=[[S[0]]],v=["first station"];for(let f=1;f<S.length;f+=2)f!==S.length-1?(V.push([S[f],S[f+1]]),v.push(`${(new Date(S[f+1]).getTime()-new Date(S[f]).getTime())/1e3/60}m`)):(V.push([S[f]]),v.push("last station"));this.dialog.open(Pe,{data:{routeId:e.routeId,path:B,time:V,stopTime:v,from:d.from,to:d.to},enterAnimationDuration:0,exitAnimationDuration:0})}onTabChange(e){this.selectedTab.set(e)}onSeatSelect(e){this.selectedSeat.set(e)}onBookSeat(){let e=this.rideId(),n=this.fromId(),d=this.toId(),w=this.selectedSeat();if(!w||!e||!n||!d)return;if(!this.authService.isLoggedIn()){this.router.navigate(["/signin"]);return}let{carId:B,seatNumber:S}=w,V=this.seatOffsets()[B]+S;this.isBooking.set(!0),this.ordersService.createOrder(V,e,n,d).pipe(X(v=>{v instanceof H?this.bookingMessage.set(v.error.message):this.bookingMessage.set("Seat has been successfully booked")}),W(()=>this.searchService.getRide(this.rideId()))).subscribe(v=>{this.selectedSeat.set(null),this.isBooking.set(!1),!(v instanceof H)&&this.ride.set(v)})}};a.\u0275fac=function(n){return new(n||a)(I(be),I(ve),I(ke),I(Se),I(pe),I(le),I(de),I(re),I(Ce))},a.\u0275cmp=A({type:a,selectors:[["app-trip-page"]],standalone:!0,features:[$],decls:2,vars:1,consts:[[1,"spinner"],[1,"header"],["mat-button","",3,"click"],[1,"icon"],[1,"header__content"],[1,"header__route"],[1,"header__ride"],["mat-button","",1,"button","modal",3,"click"],[1,"icon","modal"],[1,"main"],["animationDuration","0ms",1,"tab-group",3,"selectedIndexChange"],[1,"tab"],[1,"book"],[1,"book__error"],["mat-tab-label",""],[1,"cards-list"],[3,"card","selected"],[1,"tab__label"],[1,"tab__heading"],[1,"tab__carriage"],[1,"tab__price"],[3,"seatSelected","card","selected"],[1,"book__title"],["mat-button","",3,"disabled"],["mat-flat-button",""],["diameter","35",1,"spinner"],["mat-flat-button","",3,"click"]],template:function(n,d){n&1&&y(0,Ae,1,0,"mat-spinner",0)(1,Je,23,12),n&2&&N(d.isLoading()?0:1)},dependencies:[ye,_e,me,xe,fe,Te,Me,Ie,we,ce],styles:["[_nghost-%COMP%]{display:block;max-width:1300px;margin:0 auto;padding:20px}.spinner[_ngcontent-%COMP%]{margin:50px auto}.icon[_ngcontent-%COMP%]{width:24px!important;height:24px!important;margin:0!important;font-size:24px!important}.header[_ngcontent-%COMP%]{display:flex;align-items:center;border-bottom:1px solid #ccc;font-weight:800}.main[_ngcontent-%COMP%]{display:flex;align-items:end;justify-content:space-around;gap:30px;margin:20px 0}@media (max-width: 920px){.main[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}}.tab-group[_ngcontent-%COMP%]{min-width:0}.tab__label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:5px}.tab__heading[_ngcontent-%COMP%]{display:flex;align-items:center;font-weight:800}.tab__carriage[_ngcontent-%COMP%]{display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis}.cards-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px;margin-top:20px}.book[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:20px;gap:15px;border:1px solid #ccc;border-radius:12px;font-size:14px;position:sticky;bottom:24px;min-width:170px}.book__title[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding-bottom:7px;border-bottom:1px solid #ccc}.book__error[_ngcontent-%COMP%]{max-width:170px;text-align:center}@media (max-width: 920px){.book__error[_ngcontent-%COMP%]{max-width:100%}}@media (max-width: 920px){.book[_ngcontent-%COMP%]{padding:20px 50px;position:static}}@media (max-width: 600px){.book[_ngcontent-%COMP%]{padding:20px 30px}}.hidden[_ngcontent-%COMP%]{visibility:hidden}"],changeDetection:0});let t=a;return t})();export{It as TripPageComponent};
